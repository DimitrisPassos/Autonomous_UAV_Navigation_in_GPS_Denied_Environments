<launch>

    <!-- Launch other relevant files-->

    <!-- Arguments for launch file with defaults provided -->
    <arg name="rgb_topic" default="/camera/rgb/image_raw"/>
    <arg name="depth_topic" default="/camera/depth/points"/>
    <arg name="camera_info_topic" default="/camera/rgb/camera_info"/>  
    <arg name="depth_image_raw_topic" default="/camera/depth/image_raw"/>
    <arg name="depth_camera_info_topic" default="/camera/depth/camera_info"/>
    <arg name="rtabmap_viz" value="false"/>
     
    <group ns="rtabmap">
        <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="--delete_db_on_start">

            <!-- Basic RTAB-Map Parameters -->
            <param name="frame_id" type="string" value="base_link"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <!-- <param name="publish_tf_odom" type="bool" value="true"/> -->
            <remap from="odom" to="/odom"/>
            <param name="Odom/Strategy" type="string" value="0"/> 
            <param name="Grid/Sensor" type="string" value="2"/> 

            <param name="RGBD/LocalizeOnly" type="string" value="false"/>
            <param name="RGBD/OptimizeFromGraphEnd" type="string" value="true"/>
            <param name="Grid/Global" type="string" value="true"/>
        <!-- <param name="RGBD/NeighborLinkRefining" type="string" value="true"/>
        <param name="RGBD/ProximityBySpace"     type="string" value="true"/> -->
            <!-- RTAB-Map Inputs -->
            <remap from="scan" to="/scan"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_image_raw_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <param name="GPS/Enabled" type="bool" value="false"/>

            <!-- RTAB-Map Output -->
            <remap from="grid_map" to="/map"/>

            <!-- Additional Parameters -->
            <param name="Rtabmap/DetectionRate" type="string" value="1"/>
            <param name="RGBD/OptimizeMaxError" type="double" value="0.0" />
            <param name="Reg/Force3DoF" type="string" value="true"/>
            <param name="Grid/3D" type="string" value="true"/>
            <param name="RGBD/Grids3D" type="string" value="true"/>
            <param name="Grid/RangeMax" type="double" value="40"/>
            <param name="Grid/RayTracing" type="bool" value="true"/>
            <param name="Grid/MaxObstacleHeight" type="double" value="3.0"/>
            <param name="Kp/DetectorStrategy" type="string" value="0"/>
            <param name="Kp/MaxFeatures" type="string" value="400"/>
            <param name="SURF/HessianThreshold" type="string" value="1000"/>
            <param name="Reg/Strategy" type="string" value="1"/>
            <param name="Vis/MinInliers" type="string" value="3"/>
            <param name="Mem/NotLinkedNodesKept" type="string" value="false"/>
            <param name="Rtabmap/GoalOutput" type="string" value="frontier"/>
            <param name="Rtabmap/DetectionRate" type="double" value="100.0"/>  <!-- 2 Hz -->
        </node>

        <!-- RTAB-Map Visualization Node -->
        <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_footprint"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_image_raw_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <remap from="scan" to="/scan"/>
        </node>
    </group>

        <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_footprint"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_image_raw_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <remap from="scan" to="/scan"/>
        </node>
</launch>
