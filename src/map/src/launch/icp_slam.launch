<launch>
    <arg name="rgb_topic" default="/camera/rgb/image_raw"/>
    <arg name="depth_topic" default="/camera/depth/image_raw"/>
    <arg name="camera_info_topic" default="/camera/rgb/camera_info"/>
    <arg name="depth_camera_info_topic" default="/camera/depth/camera_info"/>
    <arg name="3d_nav" default="true"/>
    <arg name="rtabmap_viz" value="true"/>


    <group ns="rtabmap">

        <node pkg="nodelet" type="nodelet" name="imu_to_tf" args="standalone rtabmap_util/imu_to_tf">
            <remap from="imu/data" to="/raw_imu"/>
            <param name="fixed_frame_id" value="base_link_stabilized"/>
            <param name="base_frame_id" value="base_link"/>
        </node>

        <node pkg="rtabmap_odom" type="icp_odometry" name="icp_odometry" clear_params="false" output="screen" launch-prefix="">
            <remap from="scan" to="/scan"/>
            <remap from="scan_cloud" to="/camera/depth/points"/>
            <remap from="odom" to="/odom"/>
            <remap from="imu" to="/raw_imu"/>
            <remap from="odom" to="/odom"/>
            <param name="frame_id" type="string" value="base_link_stabilized"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="publish_tf" type="bool" value="true"/>
            <param name="ground_truth_frame_id" type="string" value=""/>
            <param name="ground_truth_base_frame_id" type="string" value=""/>
            <param name="wait_for_transform_duration" type="double" value="0.1"/>
            <!-- <param name="guess_frame_id" type="string" value="odom"/> -->
            <param name="guess_min_translation" type="double" value="0.01"/>
            <param name="guess_min_rotation" type="double" value="0.01"/>
            <param name="wait_imu_to_init" type="bool" value="false"/>
            <param name="config_path" type="string" value=""/>
            <param name="topic_queue_size" type="int" value="10"/>
            <param name="sync_queue_size" type="int" value="10"/>
            <!-- <param name="guess_frame_id" type="string" value="odom"/> -->
            <!-- <param name="guess_min_translation" type="double" value="0.0"/>
            <param name="guess_min_rotation" type="double" value="0.0"/> -->
            <param name="scan_cloud_max_points" type="int" value="20000"/>
            <param name="expected_update_rate" type="double" value="10.0"/>
            <param name="max_update_rate" type="double" value="20.0"/>
            <param name="deskewing" type="bool" value="false"/>
            <param name="deskewing_slerp" type="bool" value="false"/>
            <param name="publish_null_when_lost" value="false"/>
            <param name="Odom/ResetCountdown" value="1"/>
        </node>


        <node name="rtabmap_sl" pkg="rtabmap_slam" type="rtabmap" output="screen" args="--delete_db_on_start">

            <param name="publish_tf_odom" type="bool" value="true"/>
            <param name="publish_tf_map" type="bool" value="true"/>
            <param name="publish_tf" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_link_stabilized"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="map_frame_id" type="string" value="map"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <param name="Grid/RangeMax" type="double" value="40"/>
            <remap from="imu_topic" to="/raw_imu"/> 

            <remap from="scan" to="/scan"/>
            <remap from="grid_map" to="/map"/>
            <param name="Grid/3D" type="string" value="true"/>
            <param name="RGBD/LoopClosureDetection" type="bool" value="true"/>
            <param name="RGBD/ProximityBySpace" type="bool" value="true"/>
            <param name="RGBD/ProximityPathMaxNeighbors" type="int" value="10"/>
            <param name="RGBD/OptimizeFromGraphEnd" type="bool" value="true"/>
            <!-- <remap from="odom" to="/odom"/> -->
            <!-- <param name="Optimizer/Strategy" type="int" value="2"/> -->
            <param name="Mem/IncrementalMemory" type="bool" value="true"/>
            <param name="RGBD/OptimizeMaxError"                type="double"      value="0.1"  />
            <param name="Rtabmap/DetectionRate" type="string" value="5"/>
            <!-- <param name="odom_tf_linear_variance"    value="0.0001"/>
            <param name="odom_tf_angular_variance"   value="0.001"/> -->
            <!-- <param name="Grid/MinGroundHeight"                type="double"      value="1.0"  /> -->
            <!-- <param name="Grid/MaxGroundHeight"                type="double"      value="2.0"  /> -->
            <param name="Grid/RayTracing" type="bool" value="true"/>
            <param name="RGBD/Grids3D" type="string" value="true"/>
            <!-- <param name="Grid/MaxObstacleHeight" type="double" value="2.0"/> -->
            <!-- <param name="RGBD/LocalizeOnly" type="string" value="false"/> -->
                
            <param name="Grid/Global" type="string" value="true"/>
            <!-- Make sure remaps match your topic names -->
            
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <remap from="rgb/image" to="/camera/rgb/image_raw"/>
            <remap from="depth/image" to="/camera/depth/image_raw"/>
            <remap from="rgb/camera_info" to="/camera/rgb/camera_info"/>
            
            <param name="Grid/Sensor" type="string" value="2"/> 
            <param name="/rtabmap/rtabmap/use_action_for_goal" value="true"/>
            <remap from="/rtabmap/move_base" to="/move_base"/>
            <!-- <param name="Rtabmap/GoalOutput" type="string" value="frontier"/> -->
        </node>

        <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_link"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="scan" to="/scan"/>
            <param name="subscribe_imu" type="bool" value="true"/>
            <remap from="imu_topic" to="/raw_imu"/> 
            <remap from="cloud_in" to="/camera/depth/points"/>

        </node>



    </group>

</launch>
