<launch>
    <arg name="rgb_topic" default="/camera/rgb/image_raw"/>
    <arg name="depth_topic" default="/camera/depth/image_raw"/>
    <arg name="camera_info_topic" default="/camera/rgb/camera_info"/>
    <arg name="depth_camera_info_topic" default="/camera/depth/camera_info"/>
    <arg name="rtabmap_viz" value="false"/>


    <group ns="rtabmap">
            

        <node name="rtabmap_odometry" pkg="rtabmap_odom" type="rgbd_odometry" output="screen">
            
            <param name="publish_tf_odom" type="bool" value="true"/>
            <param name="publish_tf_map" type="bool" value="true"/>
            <param name="publish_tf" type="bool" value="false"/>
            <param name="frame_id" type="string" value="base_link"/>
            <param name="map_frame_id" type="string" value="map"/>
            <param name="odom_frame_id" type="string" value="mpo"/>
            <param name="subscribe_scan" type="bool" value="false"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <param name="subscribe_imu" type="bool" value="false"/>
            <!-- <param name="subscribe_rgbd" type="bool" value="true"/> -->
            <remap from="imu" to="/raw_imu"/> 
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <param name="Reg/Force3DoF" type="string" value="false"/>
            <param name="Odom/Strategy" type="string" value="0"/> 
            <param name="publish_null_when_lost" value="false"/>
            <param name="Odom/ResetCountdown" value="1"/>
            <remap from="odom" to="/gen_odom"/>
            <!-- <remap from="odom" to="/odom"/> -->
            <!-- <param name="subscribe_height" type="bool" value="true"/>
            <remap from="height" to="/sonar_height"/>  -->

            
        </node>


    <!-- Dynamic Transform for Stabilized Frame using message_to_tf -->

        <node name="rtabmap_slam" pkg="rtabmap_slam" type="rtabmap" output="screen" args="--delete_db_on_start">
            <param name="publish_tf_odom" type="bool" value="true"/>
            <param name="publish_tf_map" type="bool" value="true"/>
            <param name="publish_tf" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_link"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="map_frame_id" type="string" value="map"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <param name="Grid/RangeMax" type="double" value="40"/>
            <remap from="scan" to="/scan"/>
            <remap from="odom" to="/rtabmap/filtered/odom"/>
            <param name="Odom/Strategy" type="string" value="0"/> 
            <param name="publish_null_when_lost" value="false"/>
            <param name="Odom/ResetCountdown" value="1"/>
            <remap from="odom" to="/odom"/>
            <remap from="grid_map" to="/map"/>
            <param name="Grid/3D" type="string" value="true"/>
            <param name="RGBD/LoopClosureDetection" type="bool" value="true"/>
            <param name="RGBD/ProximityBySpace" type="bool" value="true"/>
            <param name="RGBD/ProximityPathMaxNeighbors" type="int" value="10"/>
            <param name="RGBD/OptimizeFromGraphEnd" type="bool" value="true"/>

            <!-- <param name="Optimizer/Strategy" type="int" value="2"/> -->
            <param name="Mem/IncrementalMemory" type="bool" value="true"/>
            <param name="RGBD/OptimizeMaxError"                type="double"      value="0.1"  />
            <param name="Rtabmap/DetectionRate" type="string" value="5"/>
            <!-- <param name="Grid/MinGroundHeight"                type="double"      value="0.0"  /> -->
            <!-- <param name="Grid/MaxGroundHeight"                type="double"      value="2.0"  /> -->
            <param name="Grid/RayTracing" type="bool" value="true"/>
            <param name="RGBD/Grids3D" type="string" value="true"/>
            <param name="Grid/MaxObstacleHeight" type="double" value="2.0"/>
            <!-- <param name="RGBD/LocalizeOnly" type="string" value="false"/> -->
                
            <param name="Grid/Global" type="string" value="true"/>
            <!-- Make sure remaps match your topic names -->
            
            <remap from="depth/camera_info" to="$(arg depth_camera_info_topic)"/>
            <remap from="rgb/image" to="/camera/rgb/image_raw"/>
            <remap from="depth/image" to="/camera/depth/image_raw"/>
            <remap from="rgb/camera_info" to="/camera/rgb/camera_info"/>
            
            <param name="Grid/Sensor" type="string" value="2"/> 
            <!-- <param name="Rtabmap/GoalOutput" type="string" value="frontier"/> -->
        </node>
            <node pkg="robot_localization" type="ekf_localization_node" name="ekf_localization_node" output="screen" clear_params="true">
        <rosparam command="load" file="$(find custom_scripts)/src/launch/particle.yaml" />
        <param name="use_sim_time" value="true"/>
    </node>
        <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_link"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/camera_info" to="$(arg camera_info_topic)"/>
            <param name="subscribe_odometry" type="bool" value="true"/>

            <remap from="scan" to="/scan"/>
            <param name="subscribe_imu" type="bool" value="true"/>
            <remap from="imu" to="/raw_imu"/> 
            <remap from="cloud_in" to="/camera/depth/points"/>
        </node>



    </group>

</launch>
